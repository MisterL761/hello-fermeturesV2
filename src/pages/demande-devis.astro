---
import Layout from '../layouts/Layout.astro';
---

<Layout
    title="Demandez votre devis en ligne pour vos menuiseries, 100% gratuit, rapide"
    description="Demandez votre devis gratuit et personnalisé pour vos travaux de fermetures : volets, stores, portes, fenêtres. Hello Fermetures vous accompagne avec expertise et rapidité. Estimation en ligne !"
>


<div class="container-devis">
    <div class="intro-section">
        <h1 class="font-display">Demandez votre devis</h1>
        <p>
            Obtenez un devis <strong>gratuit</strong> et personnalisé pour vos travaux de fermetures.
            Remplissez le formulaire ci-dessous et notre équipe vous recontactera rapidement.
        </p>
    </div>

    <div class="form-container">
        <h2 class="font-display">Demande de Devis</h2>

        <div id="message-container"></div>

        <form id="devis-form">
            <div class="form-grid">
                <div class="form-group">
                    <label for="nom">Nom *</label>
                    <input type="text" id="nom" name="nom" required>
                </div>

                <div class="form-group">
                    <label for="prenom">Prénom *</label>
                    <input type="text" id="prenom" name="prenom" required>
                </div>

                <div class="form-group">
                    <label for="email">E-mail *</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <div class="form-group">
                    <label for="telephone">Tél. portable *</label>
                    <input type="tel" id="telephone" name="telephone" required>
                </div>

                <div class="form-group">
                    <label for="ville">Ville *</label>
                    <input type="text" id="ville" name="ville" required>
                </div>

                <div class="form-group">
                    <label for="postcode">Code postal *</label>
                    <input type="text" id="postcode" name="postcode" required pattern="\d{5}" title="Entrez un code postal valide (5 chiffres)">
                </div>

                <div class="form-group full-width">
                    <label for="adresse">Adresse *</label>
                    <input type="text" id="adresse" name="adresse" required>
                </div>

                <div class="form-group full-width">
                    <label>Produit concerné *</label>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" name="gamme" value="Fenêtres" id="gamme-fenetre">
                            <label for="gamme-fenetre">Fenêtres</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="gamme" value="Volets" id="gamme-volets">
                            <label for="gamme-volets">Volets</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="gamme" value="Porte" id="gamme-porte">
                            <label for="gamme-porte">Portes</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="gamme" value="Stores intérieurs" id="gamme-stores">
                            <label for="gamme-stores">Stores</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="gamme" value="Porte de garage" id="gamme-garage">
                            <label for="gamme-garage">Porte de garage</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="gamme" value="Portail" id="gamme-portail">
                            <label for="gamme-portail">Portail / Clôture</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="gamme" value="Pergola" id="gamme-pergola">
                            <label for="gamme-pergola">Pergola / Véranda</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="gamme" value="Autres" id="gamme-autres">
                            <label for="gamme-autres">Autres</label>
                        </div>
                    </div>
                </div>

                <div class="form-group full-width">
                    <label for="delai">Délai souhaité *</label>
                    <select id="delai" name="delai" required>
                        <option value="">Sélectionner</option>
                        <option value="Urgent">Urgent</option>
                        <option value="1 mois">1 mois</option>
                        <option value="3 mois">3 mois</option>
                        <option value="6 mois et plus">6 mois et plus</option>
                    </select>
                </div>

                <div class="form-group full-width">
                    <label for="details">Détails du projet</label>
                    <textarea id="details" name="details" rows="3" placeholder="Décrivez brièvement votre projet..."></textarea>
                </div>
            </div>

            <div class="consent-group">
                <input type="checkbox" name="consent" id="consent" required>
                <p>
                    <label for="consent">En soumettant ce formulaire, j'accepte que les informations saisies soient exploitées par Hello Fermetures.</label>
                </p>
            </div>

            <button class="submit-btn" id="submit-btn" type="submit">Envoyer la demande</button>
        </form>
    </div>
</div>

</Layout>

<script is:inline>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("devis-form");
        const submitBtn = document.getElementById("submit-btn");
        const messageContainer = document.getElementById("message-container");

        function showMessage(message, type) {
            messageContainer.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, 5000);
        }

        form.addEventListener("submit", function (event) {
            event.preventDefault();

            submitBtn.disabled = true;
            submitBtn.textContent = "Envoi en cours...";

            let formData = new FormData(form);

            let jsonData = {
                "token": "rT1ZV1OycYA=",
                "form": "DemandeDevisHelloFermetures",
                "ctc_lastname": formData.get("nom"),
                "ctc_firstname": formData.get("prenom"),
                "ctc_email": formData.get("email"),
                "ctc_mobile": formData.get("telephone"),
                "ctc_address": formData.get("adresse"),
                "ctc_postcode": formData.get("postcode"),
                "ctc_city": formData.get("ville"),
                "ctc_country": "FR",
                "ctc_consent": formData.get("consent") ? "TRUE" : "FALSE",
                "prj_channel": "CNL_9555",
                "prj_message": formData.get("details"),
                "prj_request": "RTY_762",
            };

            const delaiMapping = {
                "Urgent": "DLY_731",
                "1 mois": "DLY_732",
                "3 mois": "DLY_733",
                "6 mois et plus": "DLY_734"
            };
            jsonData["prj_delay"] = delaiMapping[formData.get("delai")] || "";

            const gammeMapping = {
                "Fenêtres": "RNG_1255",
                "Volets": "RNG_1256",
                "Porte": "RNG_1257",
                "Stores intérieurs": "RNG_1258",
                "Stores bannes": "RNG_1259",
                "Moustiquaires": "RNG_1260",
                "Porte de garage": "RNG_1261",
                "Portail": "RNG_1262",
                "Clôtures": "RNG_1263",
                "Pergola": "RNG_1266",
                "Domotique": "RNG_1265",
                "Motorisation": "RNG_1267",
                "Véranda": "RNG_1268",
                "Garde corps": "RNG_1392",
                "Vitrage": "RNG_4633",
                "Abris de piscine": "RNG_4634",
                "A définir": "RNG_4288",
                "Alarme": "RNG_1264",
                "SAV": "RNG_1975",
                "Autres": "RNG_4288",
                "Marquises": "RNG_6480"
            };

            const selectedGammes = formData.getAll("gamme").map(g => gammeMapping[g] || "RNG_4288");
            jsonData["prj_range"] = selectedGammes.join(",");

            fetch("https://leadimport.oplead.com/addlead/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erreur HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Réponse de l'API :", data);
                if (data.status === "OK" && parseInt(data.lead.lead_id) > 0) {
                    showMessage("✅ Votre demande a bien été envoyée ! Nous vous contacterons rapidement.", "success");
                    form.reset();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    showMessage("⚠️ La demande a été traitée mais le lead n'a pas été créé. Veuillez réessayer ou nous contacter directement.", "error");
                }
            })
            .catch(error => {
                showMessage("❌ Erreur lors de l'envoi : " + error.message + ". Veuillez réessayer ou nous contacter par téléphone.", "error");
                console.error("Erreur :", error);
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.textContent = "Envoyer la demande";
            });
        });
    });
</script>
